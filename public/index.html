<html>
  <head>
    <link rel="stylesheet" type="text/css" href="styles.css">
  </head>
  <body>
    <section>
      <div id="chat"></div>
      <input type="text" id="name" placeholder="Enter Your Name">
      <input type="text" id="input" disabled="disabled">
      <select id="users">
        <option value="">all Users</option>          
      </select>
    </section>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var addEventListener = function(obj, e, func) {
        if (obj.addEventListener) {
          obj.addEventListener(e, func, false);
            return true;
        } else if (obj.attachEvent) {
            return obj.attachEvent('on' + e, func);
        }
      };
      var randomColors = function() {
        var characters = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
          color += characters[Math.round(Math.random() * 15)];
        }
        return color;
      }
    </script>
    <script>
      window.onload = function() {
        var Chat = (function() {
          var socket = io.connect('http://localhost:4568'),
            chat = document.querySelector("#chat"),
            input = document.querySelector("#input"),
            name = document.querySelector("#name"),
            users = document.querySelector("#users"),
            selectUser = null,
            id = null,
            color = randomColors();

          var send = function(message) {
            var username = name.value == '' ? '' : '<strong>' + name.value + ': </strong>';
            socket.emit('send', { 
              message: '<span style="color:' + color + '">' + username + message + '</span>',
              username: name.value,
              toUser: users.value,
              fromUser: id
            });
          };

          var display = function(message) {
            chat.innerHTML = chat.innerHTML + message + '<br />';
            chat.scrollTop = chat.scrollHeight;
          }

          addEventListener(input, "keydown", function(e) {
            if(e.keyCode === 13) {
              send(input.value);
              input.value = "";
            }
          });

          addEventListener(users, "change", function(e) {
            selectUser = users.value;
          });

          socket.on('welcome', function (data) {
            id = data.id;
            display(data.message);
            input.removeAttribute("disabled");
            input.focus();
          }).on('receive', function (data) {
            display(data.message);
          }).on('users', function (data) {
            var html = '<option value="">All Users</option>';
            for(var i = 0; i < data.length; i++) {
              var user = data[i];
              if(id != user.id) {
                var username = user.name ? user.name : 'user' + (i+1);
                var selected = user.id === selectUser ? ' selected="selected"': '';
                html += '<option value="' + user.id + '"' + selected + '>' + username + '</option>';
              }
            }
            users.innerHTML = html;
          });

        })();       
      }
    </script>
    </body>
</html>